<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Admin Profile - Lensheem</title>
    
    <!-- Existing CSS links -->
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" />
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
    <link rel="stylesheet" href="assets/css/style.css">
    
    <style>
        /* Copy relevant styles from index-admin.html */
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: #ffffff;
            min-height: 100vh;
            color: #333;
        }

        .admin-container {
            display: flex;
            flex-direction: column;
            min-height: 100vh;
        }

        .admin-main {
            flex: 1;
            background: #fafafa;
            display: flex;
        }

        /* Sidebar Styles - Copied from index-admin.html */
        .admin-sidebar {
            width: 280px;
            background: white;
            padding: 25px;
            display: flex;
            flex-direction: column;
            box-shadow: 2px 0 15px rgba(0,0,0,0.05);
            border-right: 1px solid #f0f0f0;
        }

        .admin-logo {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 40px;
            padding: 15px;
            background: linear-gradient(135deg, #fff9c4, #fff59d);
            border-radius: 15px;
            border: 1px solid #ffe082;
        }

        .admin-logo-icon {
            width: 45px;
            height: 45px;
            background: linear-gradient(135deg, #ffc107, #ff9800);
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 22px;
            font-weight: bold;
            color: white;
            box-shadow: 0 4px 15px rgba(255,193,7,0.3);
        }

        .admin-logo-text {
            font-size: 24px;
            font-weight: bold;
            color: #333;
        }

        .admin-nav {
            flex: 1;
        }

        .nav-section {
            margin-bottom: 30px;
        }

        .nav-section-title {
            font-size: 12px;
            text-transform: uppercase;
            color: #999;
            margin-bottom: 15px;
            padding-left: 10px;
            font-weight: 600;
            letter-spacing: 1px;
        }

        .sidebar-nav-item {
            display: flex;
            align-items: center;
            gap: 15px;
            padding: 12px 15px;
            margin-bottom: 5px;
            border-radius: 10px;
            cursor: pointer;
            transition: all 0.3s ease;
            color: #666;
            text-decoration: none;
        }

        .sidebar-nav-item:hover {
            background: #fff9c4;
            color: #333;
            transform: translateX(5px);
        }

        .sidebar-nav-item.active {
            background: linear-gradient(135deg, #ffc107, #ff9800);
            color: white;
            box-shadow: 0 4px 15px rgba(255,193,7,0.3);
        }

        .sidebar-nav-item i {
            width: 20px;
            text-align: center;
            font-size: 16px;
        }

        .sidebar-nav-item-text {
            font-size: 14px;
            font-weight: 500;
        }

        /* Profile Content Styles */
        .profile-content {
            flex: 1;
            padding: 30px;
        }

        .page-header {
            padding: 20px 0;
            margin-bottom: 30px;
        }

        .page-title {
            font-size: 28px;
            font-weight: bold;
            color: #333;
            margin: 0 0 10px 0;
        }

        .page-subtitle {
            color: #6c757d;
            margin: 0;
        }

        .profile-card {
            background: white;
            border-radius: 15px;
            box-shadow: 0 5px 25px rgba(0,0,0,0.08);
            padding: 30px;
            margin-bottom: 30px;
        }

        .profile-image-container {
            text-align: center;
            margin-bottom: 30px;
        }

        .profile-image {
            width: 120px;
            height: 120px;
            border-radius: 50%;
            object-fit: cover;
            border: 3px solid #fff;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
            display: block;
            margin: 0 auto 20px;
        }

        .camera-icon {
            position: absolute;
            right: 8px;
            bottom: 8px;
            background: #ff4500;
            color: white;
            width: 28px;
            height: 28px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            box-shadow: 0 1px 3px rgba(0,0,0,0.2);
            font-size: 12px;
        }

        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            font-weight: 500;
            margin-bottom: 8px;
            color: #495057;
        }

        .form-control {
            width: 100%;
            padding: 12px 14px;
            border: 1px solid #e0e0e0;
            border-radius: 6px;
            font-size: 15px;
            background-color: #f8f9fa;
            transition: border-color 0.15s ease-in-out;
        }

        .form-control:focus {
            border-color: #ffc107;
            outline: 0;
            box-shadow: 0 0 0 0.2rem rgba(255, 193, 7, 0.25);
        }

        .form-row {
            display: flex;
            gap: 15px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }

        .form-col {
            flex: 1;
            min-width: 180px;
        }

        .btn-save {
            width: 100%;
            padding: 12px;
            border: none;
            border-radius: 6px;
            font-size: 15px;
            font-weight: 500;
            background-color: #ff4500;
            color: white;
            cursor: pointer;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            transition: background-color 0.3s ease;
        }

        .btn-save:hover {
            background-color: #e03e00;
        }

        .profile-message {
            text-align: center;
            margin-top: 15px;
            padding: 10px;
            border-radius: 6px;
            font-size: 14px;
        }

        .profile-message.success {
            background-color: #d4edda;
            color: #155724;
        }

        .profile-message.error {
            background-color: #f8d7da;
            color: #721c24;
        }

        /* Responsive Design */
        @media (max-width: 768px) {
            .admin-sidebar {
                width: 70px;
                padding: 15px 10px;
            }

            .admin-logo-text,
            .sidebar-nav-item-text,
            .nav-section-title {
                display: none;
            }

            .admin-logo {
                justify-content: center;
                margin-bottom: 30px;
            }

            .sidebar-nav-item {
                justify-content: center;
                padding: 15px 10px;
            }

            .form-row {
                flex-direction: column;
                gap: 0;
            }

            .form-col {
                min-width: 100%;
            }
        }
    </style>
</head>
<body>
    <div class="admin-container">
        <!-- Include admin header -->
        <iframe src="admin-header.html" style="width:100%;height:90px;border:none;" title="Admin Header"></iframe>

        <div class="admin-main">
            <!-- Sidebar - Copied from index-admin.html -->
            <div class="admin-sidebar">
                <div class="admin-logo">
                    <div class="admin-logo-icon">A</div>
                    <div class="admin-logo-text">AdminPanel</div>
                </div>

                <nav class="admin-nav">
                    <div class="nav-section">
                        <div class="nav-section-title">Quick Actions</div>
                        <a href="index-admin.html" class="sidebar-nav-item">
                            <i class="fas fa-tachometer-alt"></i>
                            <span class="sidebar-nav-item-text">Dashboard</span>
                        </a>
                        <a href="user.html" class="sidebar-nav-item">
                            <i class="fas fa-users"></i>
                            <span class="sidebar-nav-item-text">People</span>
                        </a>
                        <a href="admin-orders.html" class="sidebar-nav-item">
                            <i class="fas fa-shopping-cart"></i>
                            <span class="sidebar-nav-item-text">Orders</span>
                        </a>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">Management</div>
                        <a href="admin-reviews.html" class="sidebar-nav-item">
                            <i class="fas fa-star"></i>
                            <span class="sidebar-nav-item-text">Reviews</span>
                        </a>
                        <a href="category.html" class="sidebar-nav-item">
                            <i class="fas fa-list"></i>
                            <span class="sidebar-nav-item-text">Categories</span>
                        </a>
                        <a href="item.html" class="sidebar-nav-item">
                            <i class="fas fa-box"></i>
                            <span class="sidebar-nav-item-text">Items</span>
                        </a>
                    </div>

                    <div class="nav-section">
                        <div class="nav-section-title">System</div>
                        <a href="profile_admin.html" class="sidebar-nav-item active">
                            <i class="fas fa-user"></i>
                            <span class="sidebar-nav-item-text">Profile</span>
                        </a>
                        <a href="admin-settings.html" class="sidebar-nav-item">
                            <i class="fas fa-cog"></i>
                            <span class="sidebar-nav-item-text">Settings</span>
                        </a>
                        <a href="admin-backup.html" class="sidebar-nav-item">
                            <i class="fas fa-database"></i>
                            <span class="sidebar-nav-item-text">Backup</span>
                        </a>
                    </div>
                </nav>
            </div>

            <!-- Profile Content -->
            <div class="profile-content">
                <!-- Page Header -->
                <div class="page-header">
                    <h1 class="page-title"><i class="fas fa-user-edit" style="margin-right: 8px;"></i>Complete Your Profile</h1>
                    <p class="page-subtitle">Please fill in your details</p>
                </div>

                <!-- Profile Card -->
                <div class="profile-card">
                    <div class="profile-image-container">
                        <div style="position: relative; width: 120px; margin: 0 auto;">
                            <img id="profileImagePreview" src="https://via.placeholder.com/120" alt="Profile Picture" class="profile-image">
                            <label for="image" class="camera-icon">
                                <i class="fas fa-camera"></i>
                            </label>
                        </div>
                    </div>

                    <form id="profileForm" enctype="multipart/form-data">
                        <input type="hidden" name="userId" id="userId" />

                        <div class="form-group">
                            <label for="title" class="form-label">Title</label>
                            <select name="title" id="title" class="form-control">
                                <option value="" disabled selected>Select title</option>
                                <option value="Mr.">Mr.</option>
                                <option value="Ms.">Ms.</option>
                                <option value="Mrs.">Mrs.</option>
                            </select>
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="fname" class="form-label">First Name</label>
                                    <input type="text" name="fname" id="fname" placeholder="First name" required class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="lname" class="form-label">Last Name</label>
                                    <input type="text" name="lname" id="lname" placeholder="Last name" required class="form-control">
                                </div>
                            </div>
                        </div>

                        <div class="form-group">
                            <label for="addressline" class="form-label">Street Address</label>
                            <input type="text" name="addressline" id="addressline" placeholder="Street address" class="form-control">
                        </div>

                        <div class="form-row">
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="town" class="form-label">Town/City</label>
                                    <input type="text" name="town" id="town" placeholder="Town/City" class="form-control">
                                </div>
                            </div>
                            <div class="form-col">
                                <div class="form-group">
                                    <label for="phone" class="form-label">Phone Number</label>
                                    <input type="tel" name="phone" id="phone" placeholder="Phone number" class="form-control">
                                </div>
                            </div>
                        </div>

                        <div style="display: none;">
                            <input type="file" name="image" id="image" accept="image/*" />
                        </div>

                        <button type="submit" class="btn-save">
                            <span>Save Profile</span>
                            <i class="fas fa-fire" style="font-size: 14px;"></i>
                        </button>
                        
                        <div id="profileMsg" class="profile-message" style="display: none;"></div>
                    </form>
                </div>
            </div>
        </div>

        <!-- Include admin footer -->
        <iframe src="footer_admin.html" style="width:100%;border:none;" title="Admin Footer"></iframe>
    </div>

    <!-- jQuery -->
    <script src="https://code.jquery.com/jquery-3.7.1.min.js"></script>
    
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        $(document).ready(function () {
            const token = localStorage.getItem('token');
            const userId = localStorage.getItem('userId');

            // Check if user is admin
            $.ajax({
                url: 'http://localhost:3000/api/auth/admin-check',
                method: 'GET',
                headers: {
                    Authorization: 'Bearer ' + (localStorage.getItem('token') || '')
                },
                success: function (res) {
                    console.log('✅ Admin verified:', res.user);
                },
                error: function (xhr) {
                    const defaultMsg = "Only admins can access this page.";
                    const message = xhr.responseJSON?.message || defaultMsg;

                    alert(message);
                    localStorage.removeItem('token');
                    window.location.href = '/login.html';
                }
            });

            if (!token || !userId) {
                alert("You must be logged in first!");
                window.location.href = '/login.html';
                return;
            }

            $('#userId').val(userId);

            // Fetch admin profile data
            fetchProfileData();

            function fetchProfileData() {
                $.ajax({
                    url: 'http://localhost:3000/api/auth/admin-profile',
                    method: 'GET',
                    headers: {
                        'Authorization': 'Bearer ' + localStorage.getItem('token')
                    },
                    success: function (res) {
                        if (res.success && res.profile) {
                            const data = res.profile;
                            $('#title').val(data.title || '');
                            $('#fname').val(data.fname || '');
                            $('#lname').val(data.lname || '');
                            $('#addressline').val(data.addressline || '');
                            $('#town').val(data.town || '');
                            $('#phone').val(data.phone || '');
                            
                            // Store email for form submission
                            window.currentUserEmail = data.email || 'admin@lensheem.com';
                            
                            if (data.image_path) {
                                $('#profileImagePreview').attr('src', data.image_path.startsWith('http') ? data.image_path : '/' + data.image_path);
                            }
                        } else {
                            console.warn('No admin profile found or invalid response structure.');
                        }
                    },
                    error: function (xhr, status, error) {
                        console.error('Error fetching admin profile:', error);
                        console.error('Response:', xhr.responseText);
                        $('#profileMsg').text('Failed to load profile data.').removeClass('success').addClass('error').show();
                        
                        // Hide message after 3 seconds
                        setTimeout(function() {
                            $('#profileMsg').hide();
                        }, 3000);
                    }
                });
            }

            $('#image').on('change', function () {
                const file = this.files[0];
                if (file) {
                    $('#profileImagePreview').attr('src', URL.createObjectURL(file));
                }
            });

$('#profileForm').on('submit', function (e) {
    e.preventDefault();

    const formData = new FormData(this);
    
    // Set admin table fields only
    const fname = $('#fname').val();
    const lname = $('#lname').val();
    
    formData.set('fname', fname);
    formData.set('lname', lname);
    formData.set('phone', $('#phone').val() || '');
    formData.set('addressline', $('#addressline').val() || '');
    formData.set('town', $('#town').val() || '');
    
    console.log('Form data being sent:', {
        fname: fname,
        lname: lname,
        phone: $('#phone').val(),
        addressline: $('#addressline').val(),
        town: $('#town').val()
    });

    $.ajax({
        url: 'http://localhost:3000/api/auth/admin-profile',
        method: 'PUT',
        data: formData,
        processData: false,
        contentType: false,
        headers: {
            'Authorization': 'Bearer ' + localStorage.getItem('token')
        },
        success: function (res) {
            $('#profileMsg').text('Profile saved successfully!').removeClass('error').addClass('success').show();
            // Refresh profile data
            fetchProfileData();

            // Hide message after 3 seconds
            setTimeout(function() {
                $('#profileMsg').hide();
            }, 3000);
        },
        error: function (xhr, status, error) {
            console.error('Error saving profile:', error);
            console.error('Response:', xhr.responseText);
            $('#profileMsg').text('Failed to save profile.').removeClass('success').addClass('error').show();

            // Hide message after 3 seconds
            setTimeout(function() {
                $('#profileMsg').hide();
            }, 3000);
        }
    });
});
        });
    </script>
</body>
</html>
